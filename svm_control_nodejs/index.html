<!doctype html>
<html>
  <head>
    <title>BCI Art</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; padding: 0; margin: 0;}
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(255, 255, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
    <div id="p5container"></div>
    <div id="debug">
      <p>Debug</p>
      <ul id="messages"></ul>
      <form action="">
        <input id="m" autocomplete="off" /><button>Send</button>
      </form>
    </div>
    <script language="javascript" type="text/javascript" src="libraries/p5.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      // p5js
      
      var lhemi, rhemi;
      function Hemi(x, y, w, h) {
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = h;
        this.c = color(0);
        this.p = 0;
        this.bang = 5;
        this.bangMax = 5;
        this.predicted = function() {
          this.bang = 0;
        }
        this.progress = function(p) {
          this.p = p;
        }
        this.draw = function() {
          fill(this.c);
          rect(this.x, this.y, this.w, this.h);
          if(this.bang < this.bangMax) {
            fill(255, 128 * this.bang / this.bangMax);
          }
          else
            fill(255, 128);
          rect(this.x, this.y + this.h * (1 - this.p), this.w, this.h + this.p);
          
          this.bang++;
        }
        this.inside = function(x, y) {
          if(this.x < x && x < this.x + this.w && this.y < y && y < this.y + this.h)
            return true;
          else
            return false;
        }
      };

      function reset() {
        socket.emit('bci command', "/bci_art/svm/reset");
        lcolor = color(255, 0, 0);
        rcolor = color(0, 0, 255);
        lhemi = new Hemi(0, 0, width * 0.5, height);
        lhemi.c = color(255, 0, 0);
        rhemi = new Hemi(width * 0.5, 0, width * 0.5, height);
        rhemi.c = color(0, 0, 255);
      }
      
      function setup() {
        noStroke();
        var pcanvas = createCanvas(640, 480);
        frameRate(10);
        pcanvas.parent('p5container');
        reset();
      }

      function draw() {
        lhemi.draw();
        rhemi.draw();
        fill(0); // reset button
        b = 50;
        rect(width - b, height - b, b, b);
      }
      
      function mousePressed() {
        if(mouseY > 0 && mouseY < height && mouseX > 0 && mouseX < width) { // on canvas
          b = 50;
          if(mouseX > width - b && mouseY > height - b) { // reset button
            reset();
          }
          else {
            if(lhemi.inside(mouseX, mouseY))
              socket.emit('bci command', "/bci_art/svm/start/1");
            else if(rhemi.inside(mouseX, mouseY))
              socket.emit('bci command', "/bci_art/svm/start/2");
            }
        }
      }
      
      // socket.io
      
      var socket = io();
      $('form').submit(function(){
        socket.emit('bci command', $('#m').val());
        $('#m').val('');
        return false;
      });
      socket.on('bci command', function(msg){
        $('#messages').prepend($('<li>').text(msg));
        var count = 0;
        $("li").each(function( index ) {
          count++;
          if(count > 5)
            $( this ).remove();
        });
        
        if(msg == "/bci_art/svm/done/1") {
        }
        if(msg == "/bci_art/svm/done/2") {
        }
        if(msg[0] == "/bci_art/svm/progress/1") {
          lhemi.progress(msg[1] / msg[2]);
        }
        if(msg[0] == "/bci_art/svm/progress/2") {
          rhemi.progress(msg[1] / msg[2]);
        }
        if(msg[0] == "/bci_art/svm/prediction") {
          if(msg[1] == 0)
            lhemi.predicted();
          else
            rhemi.predicted();
        }
      });
    </script>
  </body>
</html>